name: dgi_code_analysis
author: discoverygarden
description: Runs static analysis on your PHP code.

inputs:
  path:
    description: The path (or paths) to run the analysis on.
    required: true
  extensions:
    description: Comma separated list of file extensions to test.
    required: false
    default: php,module,inc,install,test,profile,theme,css,info,txt,md,yml

runs:
  using: "composite"
  steps:
    - name: Download PHPStan
      run: wget --quiet -P ${{ runner.temp }} https://github.com/phpstan/phpstan/raw/master/phpstan.phar
      shell: bash
      
    - name: Download PHPCS
      run: wget --quiet -P ${{ runner.temp }}  https://squizlabs.github.io/PHP_CodeSniffer/phpcs.phar
      shell: bash
    
    - name: Download Coder
      run: git clone -q https://github.com/civicrm/coder.git ${{ runner.temp }}/coder_sniffer
      shell: bash
      
    - name: Register Sniffs
      run: php ${{ runner.temp }}/phpcs.phar --config-set installed_paths ${{ runner.temp }}/coder_sniffer/coder_sniffer/
      shell: bash
    
    - name: Validate Drupal Code
      run: php ${{ runner.temp }}/phpcs.phar --standard=Drupal --extensions=${{ inputs.extensions }} ${{ inputs.path }}
      shell: bash

    - name: Validate Drupal Best Practices
      run: php ${{ runner.temp }}/phpcs.phar --standard=DrupalPractice --extensions=${{ inputs.extensions }} ${{ inputs.path }}
      shell: bash

    - name: Run Static Analysis
      run: php ${{ runner.temp }}/phpstan.phar analyse $ACTION_PATH
      shell: bash
      
branding:
  icon: 'check-square'
  color: 'blue'
